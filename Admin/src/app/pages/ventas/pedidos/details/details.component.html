<div class="details-container">
  <!-- Contenedor de alertas flotantes -->
  <div class="alert-container">
    <!-- Alerta de error -->
    <div
      *ngIf="mostrarAlertaError"
      class="alert alert-danger alert-border-left alert-dismissible fade show floating-alert"
      role="alert"
    >
      <i class="ri-error-warning-line me-3 align-middle fs-lg"></i>
      <strong>¡Error!</strong> {{ mensajeError }}
      <button
        type="button"
        class="btn-close"
        (click)="cerrarAlerta()"
        aria-label="Close"
      ></button>
    </div>
    
    <!-- Alerta de éxito -->
    <div
      *ngIf="mostrarAlertaExito"
      class="alert alert-success alert-border-left alert-dismissible fade show floating-alert"
      role="alert"
    >
      <i class="ri-check-line me-3 align-middle fs-lg"></i>
      <strong>¡Éxito!</strong> {{ mensajeExito }}
      <button
        type="button"
        class="btn-close"
        (click)="cerrarAlertaExito()"
        aria-label="Close"
      ></button>
    </div>
  </div>

  <!-- Botón de regresar -->
  <div class="details-header-button">
    <button type="button" class="btn btn-primary" (click)="cerrar()">
      <span class="btn-text">Regresar</span>
      <span class="btn-icon"><i class="ri-arrow-left-line"></i></span>
    </button>
  </div>

  <!-- Contenido de detalles -->
  <div *ngIf="!cargando && PedidoDetalle" class="details-content">
    <div class="d-flex justify-content-end mb-3 gap-2">
      <!-- Botón Venta (Factura + Impresión) -->
      <button
        type="button"
        class="btn btn-success"
        (click)="realizarVenta()"
        [disabled]="!PedidoDetalle || procesandoVenta"
      >
        <span class="btn-text" *ngIf="!procesandoVenta">Venta</span>
        <span class="btn-text" *ngIf="procesandoVenta">Procesando...</span>
        <span class="btn-icon">
          <i class="ri-shopping-cart-line" *ngIf="!procesandoVenta"></i>
          <span class="spinner-border spinner-border-sm" *ngIf="procesandoVenta" role="status"></span>
        </span>
      </button>
      
      <!-- Estos botones ya no se muestran aquí, se mostrarán a través del modal -->
      <!-- Los mantenemos ocultos para conservar la funcionalidad original -->
      <button
        type="button"
        class="btn btn-outline-primary d-none"
        (click)="generarVistaPrevia()"
        [disabled]="!PedidoDetalle"
      >
        <span class="btn-text">Ver Factura PDF</span>
        <span class="btn-icon"><i class="ri-file-pdf-line"></i></span>
      </button>
      
      <button
        type="button"
        class="btn btn-primary d-none"
        (click)="abrirConfiguracionImpresion()"
        [disabled]="!PedidoDetalle || imprimiendo"
      >
        <span class="btn-text" *ngIf="!imprimiendo">Ver Factura ZPL</span>
        <span class="btn-text" *ngIf="imprimiendo">Procesando...</span>
        <span class="btn-icon">
          <i class="ri-printer-line" *ngIf="!imprimiendo"></i>
          <span class="spinner-border spinner-border-sm" *ngIf="imprimiendo" role="status"></span>
        </span>
      </button>
    </div>

    <div class="col-md-12">
      <div class="card h-100 shadow-sm employee-details-card bg-dark-blue">
        <div
          class="card-header d-flex align-items-center rounded-top details-header-custom"
        >
          <i class="ri-shopping-basket-2-line me-2 fs-4"></i>
          <h5 class="mb-0">Detalles del Pedido</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-sm-6">
              <div class="detail-item">
                <div class="detail-icon bg-dark-blue text-white">
                  <i class="ri-store-2-line"></i>
                </div>
                <div class="detail-content">
                  <div class="detail-label">Negocio</div>
                  <div class="detail-value">
                    {{ PedidoDetalle.clie_NombreNegocio }}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="detail-item">
                <div class="detail-icon bg-dark-blue text-white">
                  <i class="bx bx-user-pin"></i>
                </div>
                <div class="detail-content">
                  <div class="detail-label">Vendedor</div>
                  <div class="detail-value">
                    {{ PedidoDetalle.vend_Nombres }}
                    {{ PedidoDetalle.vend_Apellidos }}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="detail-item">
                <div class="detail-icon bg-dark-blue text-white">
                  <i class="ri-calendar-event-line"></i>
                </div>
                <div class="detail-content">
                  <div class="detail-label">Fecha Entrega</div>
                  <div class="detail-value">
                    {{
                      formatearFecha(PedidoDetalle.pedi_FechaEntrega) || "N/A"
                    }}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="detail-item">
                <div class="detail-icon bg-dark-blue text-white">
                  <i class="ri-calendar-event-line"></i>
                </div>
                <div class="detail-content">
                  <div class="detail-label">Fecha del Pedido</div>
                  <div class="detail-value">
                    {{
                      formatearFecha(PedidoDetalle.pedi_FechaPedido) || "N/A"
                    }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="product-scroll mt-4">
    <!-- <h4 class="details-title mb-3" style="color: black">Productos</h4> -->

    <!-- <div *ngIf="productos.length > 0; else sinProductos" class="scroll-container">
      <div class="scroll-item" *ngFor="let producto of productos">

        <div class="product-info">
          <div class="fw-bold">{{ producto.descripcion }}</div>
          <div>
            <strong>Precio:</strong> {{ producto.precio | currency : "L. " }}
          </div>
          <div><strong>Cantidad:</strong> {{ producto.cantidad }}</div>
        </div>
      </div>
    </div> -->

    <div class="table-responsive mt-4">
      <table
        class="table table-borderless text-center table-nowrap align-middle mb-0"
      >
        <thead>
          <tr class="table-light">
            <th scope="col" style="width: 50px">#</th>
            <th scope="col">Descripcion</th>
            <th scope="col">Precio</th>
            <th scope="col">Cantidad</th>
            <th scope="col" class="text-end">Monto</th>
          </tr>
        </thead>
        <tbody id="products-list">
          <tr *ngFor="let producto of productos; let i = index">
            <td>
              <span>{{ i + 1 }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div>
                  <h6 class="mb-0">{{ producto.descripcion }}</h6>
                </div>
              </div>
            </td>
            <td>{{ producto.precio | currency : "L. " }}</td>
            <td>{{ producto.cantidad }}</td>
            <td class="text-end">
              {{ producto.precio * producto.cantidad | currency : "L. " }}
            </td>
          </tr>
        </tbody>
      </table>
      <!--end table-->
    </div>

    <div class="border-top border-top-dashed mt-2" id="products-list-total">
      <table
        class="table table-borderless table-nowrap align-middle mb-0 ms-auto"
        style="width: 250px"
      >
        <tbody>
          <!-- <tr>
            <th scope="row" class="text-end">Descuento:</th>
            <td class="text-end">
              {{ 0 | currency : "L. " }}
            </td>
          </tr> -->
          <tr>
            <th scope="row" class="text-end">Subtotal:</th>
            <td class="text-end">
              {{ subtotal | currency : "L. " }}
            </td>
          </tr>
          <tr>
            <th scope="row" class="text-end">Impuesto:</th>
            <td class="text-end">
              {{ impuesto | currency : "L. " }}
            </td>
          </tr>
          <tr>
            <th scope="row" class="text-end">Total:</th>
            <td class="text-end">
              {{ total | currency : "L. " }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #sinProductos>
      <p>No hay productos en este pedido.</p>
    </ng-template>
  </div>

  <ng-template #sinProductos>
    <p>No hay productos en este pedido.</p>
  </ng-template>
</div>

<!-- Modal para seleccionar formato de factura -->
<div class="modal fade modal-factura-formato" 
     [class.show]="mostrarModalFormatoFactura" 
     [style.display]="mostrarModalFormatoFactura ? 'block' : 'none'"
     id="modalFormatoFactura" 
     tabindex="-1" 
     aria-labelledby="modalFormatoFacturaLabel" 
     [attr.aria-hidden]="!mostrarModalFormatoFactura"
     (click)="onBackdropClickFormato($event)"
     *ngIf="mostrarModalFormatoFactura">

  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalFormatoFacturaLabel">
          <i class="ri-file-list-3-line me-2"></i>
          Opciones de Factura
        </h5>
        <button type="button" 
                class="btn-close btn-close-white" 
                (click)="cerrarModalFormatoFactura()" 
                aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <i class="ri-information-line me-2"></i>
          <strong>¡Factura generada correctamente!</strong> Seleccione una o ambas opciones para ver su factura.
        </div>
        
        <div class="row g-3">
          <!-- Opción PDF -->
          <div class="col-md-6">
            <div class="formato-option" 
                 [class.selected]="formatoSeleccionado === 'pdf'"
                 (click)="seleccionarFormato('pdf')">
              <div class="formato-icon">
                <i class="ri-file-pdf-line"></i>
              </div>
              <div class="formato-title">PDF</div>
              <div class="formato-desc">Ver factura en formato PDF</div>
              <button type="button" 
                      class="btn btn-sm btn-primary mt-2" 
                      (click)="generarVistaPrevia()" 
                      *ngIf="formatoSeleccionado === 'pdf'">
                <i class="ri-eye-line me-1"></i> Ver PDF
              </button>
            </div>
          </div>
          
          <!-- Opción ZPL -->
          <div class="col-md-6">
            <div class="formato-option" 
                 [class.selected]="formatoSeleccionado === 'zpl'"
                 (click)="seleccionarFormato('zpl')">
              <div class="formato-icon">
                <i class="ri-printer-line"></i>
              </div>
              <div class="formato-title">ZPL</div>
              <div class="formato-desc">Imprimir factura en formato ZPL</div>
              <button type="button" 
                      class="btn btn-sm btn-primary mt-2" 
                      (click)="abrirConfiguracionImpresion()" 
                      *ngIf="formatoSeleccionado === 'zpl'">
                <i class="ri-printer-line me-1"></i> Imprimir ZPL
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="cerrarModalFormatoFactura()">
          <i class="ri-close-line me-1"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Configuración de Impresión ZPL -->
<div class="modal fade modal-print-config" 
     [class.show]="mostrarConfiguracionImpresion" 
     [style.display]="mostrarConfiguracionImpresion ? 'block' : 'none'"
     id="modalConfiguracionImpresion" 
     tabindex="-1" 
     aria-labelledby="modalConfiguracionImpresionLabel" 
     [attr.aria-hidden]="!mostrarConfiguracionImpresion"
     (click)="onBackdropClick($event)"
     *ngIf="mostrarConfiguracionImpresion">

  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalConfiguracionImpresionLabel">
          <i class="ri-printer-line me-2"></i>
          Configuración de Impresión ZPL - Pedidos
        </h5>
        <button type="button" 
                class="btn-close btn-close-white" 
                (click)="cerrarConfiguracionImpresion()" 
                aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <!-- Sección de Método de Impresión -->
        <div class="config-section">
          <div class="config-title">
            <i class="ri-settings-3-line"></i>
            Impresión Directa con Zebra Browser Print Wrapper
          </div>
          
          <!-- Controles Zebra Wrapper -->
          <div class="zebra-wrapper-controls">
            <!-- Estado de conexión -->
            <div class="connection-status mb-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="status-info">
                  <span class="badge" 
                        [class.bg-success]="browserPrintDisponible"
                        [class.bg-danger]="!browserPrintDisponible">
                    <i class="ri-circle-fill me-1"></i>
                    {{ browserPrintDisponible ? 'Zebra Wrapper Conectado' : 'Sin Impresoras Zebra' }}
                  </span>
                </div>
                
                <button type="button" 
                        class="btn btn-sm btn-outline-primary"
                        (click)="refrescarDispositivos()"
                        [disabled]="verificandoConexion">
                  <i class="ri-refresh-line me-1" 
                    [class.spin]="verificandoConexion"></i>
                  <span *ngIf="!verificandoConexion">Actualizar</span>
                  <span *ngIf="verificandoConexion">Buscando...</span>
                </button>
              </div>
            </div>

            <!-- Lista de impresoras disponibles -->
            <div class="printer-selection mb-3" *ngIf="browserPrintDisponible && dispositivosDisponibles.length > 0">
              <label class="form-label">Impresoras Zebra Disponibles:</label>
              <div class="printer-list">
                <div class="printer-item" 
                    *ngFor="let dispositivo of dispositivosDisponibles"
                    [class.selected]="dispositivoSeleccionado?.uid === dispositivo.uid"
                    (click)="seleccionarDispositivo(dispositivo)">
                  <div class="printer-info">
                    <div class="printer-name">
                      <i class="ri-printer-line me-2"></i>
                      {{ dispositivo.name }}
                    </div>
                    <div class="printer-details text-muted small">
                      {{ dispositivo.connection }} - {{ dispositivo.deviceType }}
                    </div>
                  </div>
                  <div class="printer-actions" *ngIf="dispositivoSeleccionado?.uid === dispositivo.uid">
                    <i class="ri-check-circle-fill text-success"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Información de impresora seleccionada -->
            <div class="selected-printer mb-3" *ngIf="dispositivoSeleccionado">
              <div class="alert alert-info d-flex align-items-center">
                <i class="ri-printer-line me-2"></i>
                <div class="flex-grow-1">
                  <strong>Impresora seleccionada:</strong> {{ informacionImpresora }}
                </div>
              </div>
              
              <!-- Estado de la impresora -->
              <div class="alert mb-3" 
                   [class.alert-success]="estadoImpresora.isReadyToPrint"
                   [class.alert-warning]="!estadoImpresora.isReadyToPrint && estadoImpresora.errors">
                <div class="d-flex align-items-center">
                  <i class="ri-information-line me-2"></i>
                  <div class="flex-grow-1">
                    <strong>Estado:</strong> {{ estadoImpresoraTexto }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones de control -->
            <div class="printer-controls d-flex gap-2">
              <button type="button" 
                      class="btn btn-sm btn-outline-success"
                      (click)="probarImpresora()"
                      [disabled]="!dispositivoSeleccionado || verificandoConexion">
                <i class="ri-check-line me-1"></i>
                <span *ngIf="!verificandoConexion">Probar Impresora</span>
                <span *ngIf="verificandoConexion">Probando...</span>
              </button>
            </div>

            <!-- Mensaje de ayuda si no hay impresoras -->
            <div class="alert alert-warning" *ngIf="!browserPrintDisponible">
              <i class="ri-warning-line me-2"></i>
              <strong>No se encontraron impresoras Zebra</strong>
              <p class="mb-1 mt-2">Para usar impresión directa:</p>
              <ol class="mb-0">
                <li>Asegúrese de tener <strong>Zebra Browser Print</strong> instalado y ejecutándose</li>
                <li>Conecte su impresora Zebra y verifique que esté encendida</li>
                <li>Verifique que los drivers estén instalados correctamente</li>
                <li>Haga clic en "Actualizar" arriba</li>
              </ol>
            </div>

            <!-- Mensaje si hay Browser Print pero no impresoras -->
            <div class="alert alert-info" *ngIf="!verificandoConexion && dispositivosDisponibles.length === 0">
              <i class="ri-information-line me-2"></i>
              <strong>Browser Print activo pero sin impresoras</strong>
              <p class="mb-0 mt-2">
                Zebra Browser Print está funcionando pero no se encontraron impresoras. 
                Verifique que su impresora Zebra esté conectada, encendida y correctamente instalada.
              </p>
            </div>
          </div>
        </div>
        
        <!-- Información adicional -->
        <div class="alert alert-info d-flex align-items-start" role="alert">
          <i class="ri-information-line me-2 fs-5"></i>
          <div>
            <strong>Información:</strong>
            <ul class="mb-0 mt-2">
              <li><strong>Zebra Browser Print Wrapper:</strong> Método recomendado para impresoras Zebra</li>
              <li><strong>Compatibilidad:</strong> Funciona con Chrome, Edge, Firefox y Safari</li>
              <li><strong>Formato:</strong> Genera etiquetas ZPL optimizadas para pedidos</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="cerrarConfiguracionImpresion()">
          <i class="ri-close-line me-1"></i>
          Cancelar
        </button>
        
        <button type="button" 
                class="btn btn-primary d-flex align-items-center" 
                (click)="imprimirPedidoZPL()"
                [disabled]="imprimiendo || !dispositivoSeleccionado">
          <span *ngIf="!imprimiendo">
            <i class="ri-printer-line me-2"></i>
            Imprimir Pedido ZPL
          </span>
          <span *ngIf="imprimiendo">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Imprimiendo...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Estilos para el modal de impresión y formato de factura -->
<style>
/* Estilos para el modal de formato de factura */
.modal-factura-formato .formato-option {
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 1.5rem 1rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.modal-factura-formato .formato-option:hover {
  border-color: #20c997;
  transform: translateY(-3px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.modal-factura-formato .formato-option.selected {
  border-color: #198754;
  background-color: rgba(25, 135, 84, 0.1);
  box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
}

.modal-factura-formato .formato-icon {
  font-size: 2.5rem;
  margin-bottom: 0.75rem;
  color: #495057;
}

.modal-factura-formato .formato-option.selected .formato-icon {
  color: #198754;
}

.modal-factura-formato .formato-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.modal-factura-formato .formato-desc {
  font-size: 0.875rem;
  color: #6c757d;
}

/* Estilos para el modal de impresión */
.modal-print-config .printer-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

.modal-print-config .printer-item {
  padding: 0.75rem;
  border-bottom: 1px solid #dee2e6;
  cursor: pointer;
  transition: background-color 0.15s ease-in-out;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-print-config .printer-item:hover {
  background-color: #f8f9fa;
}

.modal-print-config .printer-item.selected {
  background-color: #e3f2fd;
  border-color: #2196f3;
}

.modal-print-config .printer-item:last-child {
  border-bottom: none;
}

.modal-print-config .config-title {
  font-weight: 600;
  margin-bottom: 1rem;
  color: #495057;
}

.modal-print-config .config-section {
  margin-bottom: 1.5rem;
}

.modal-print-config .spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.floating-alert {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1060;
  min-width: 300px;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}
</style>

<!-- Tabla de auditoría -->
<div class="audit-table-container">
  <div class="audit-table">
    <div class="audit-header">
      <div class="audit-col">Acción</div>
      <div class="audit-col">Usuario</div>
      <div class="audit-col">Fecha</div>
    </div>


    <div class="audit-row">
      <div class="audit-col">
        <span class="audit-action">Creador</span>
      </div>
      <div class="audit-col">
        <span class="audit-user">{{
          PedidoDetalle?.usuarioCreacion || "N/A"
          }}</span>
      </div>
      <div class="audit-col">
        <span class="audit-date">{{
          formatearFecha(PedidoDetalle?.pedi_FechaCreacion ?? null) || "N/A"
          }}</span>
      </div>
    </div>


    <div class="audit-row">
      <div class="audit-col">
        <span class="audit-action">Modificación</span>
      </div>
      <div class="audit-col">
        <span class="audit-user">{{
          PedidoDetalle?.usuarioModificacion || "N/A"
          }}</span>
      </div>
      <div class="audit-col">
        <span class="audit-date">{{
          formatearFecha(PedidoDetalle?.pedi_FechaModificacion ?? null) || "N/A"
          }}</span>
      </div>
    </div>
  </div>
</div>
